
<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Bibokatalog RoRo</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 800px;
      margin: auto;
      padding: 1rem;
      background: #EADDCA;
    }

    h1 {
      margin: 0;
      text-align: center;    
    }

    .header-div {
      display: flex;
      flex-direction: row;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
    }

    .bibo-h3 {
      font-weight: bold;
      margin-left: 25%;
      margin-top: 7%;
    }

    #search {
      width: 100%;
      padding: 0.5rem;
      margin-bottom: 1rem;
      font-size: 1.1rem;
      margin-top: 3%;
    }

    #auswahl-info {
      margin-top: 8%;
      margin-left: 3%;
      font-size: 20px;
    }

    .book {
      display: flex;
      gap: 1rem;
      align-items: flex-start;
      background: white;
      padding: 0.8rem;
      margin-bottom: 0.5rem;
      border-radius: 6px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      cursor: pointer;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .book:hover {
      transform: scale(1.02);
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }

    .book-details {
      flex-grow: 1;
      margin-left: 5px;
    }

    .book-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
    }

    .book-title {
      font-weight: bold;
      font-size: 1.1rem;
      margin-bottom: 0.1rem;
    }

    .book-author {
      color: #555;
      font-size: 0.95rem;
      margin: 0;
      margin-top: 5px;
    }

    .book-signature {
      font-weight: bold;
      font-size: 40px;
      color: #666;
      margin-right: 20px;
    }

    .book-meta {
      font-size: 0.85rem;
      color: #888;
      margin-top: 5%;
    }

    #lightbox-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(0,0,0,0.8);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 9999;
      cursor: pointer;
    }

    #lightbox-content {
      background: white;
      padding: 20px;
      border-radius: 8px;
      max-width: 700px;
      display: flex;
      gap: 20px;
      cursor: default;
    }

    #lightbox-content img {
      max-width: 200px;
      height: auto;
      border-radius: 6px;
      object-fit: contain;
    }
    
  .book-info {
    display: grid;
    grid-template-columns: auto 1fr;
    gap: 0 1rem;
    max-height: 180px;
    overflow-y: auto;
  }

  .book-info div {
    margin: 0;
    padding: 0;
    line-height: 1.2;
  }

  .book-info .label {
    font-weight: bold;
    white-space: nowrap;
  }

    .book-info .label {
      font-weight: bold;
      white-space: nowrap;
    }

    .logo {
        width: 150px;
        margin-top: 10px;
    }
    
    footer {
        text-align: center;
        margin-top: 10%;
    }

    footer a {
        text-decoration: none;
        color: inherit;
    }
    
    footer hr {
        width: 30%;
    }
    
    @media (max-width: 768px) {
        body {
            max-width: 300px;
            
        }

        #lightbox-content {
            flex-direction: column;
            align-items: center;
        }

        #lightbox-content img {
            max-width: 100%;
        }
        
        .search-cover {
            height: 400px !important;
            width: auto;
        }
        
        .book-details {
            height: 100px;
            position: relative;
        }
        
        .book-meta {
            position: absolute;
            bottom: 0px;          
        }
        
        .book-signature {
            white-space: nowrap;
            text-overflow: ellipsis;
        }

        .book-info {
            grid-template-columns: auto 1fr;
            gap: 0 0.5rem;
        }
        
        .logo {
            margin-top: -250px;
            margin-left: 28%;
        }
        
        .header-div {
            margin-top: 40%;
        }
        
        .bibo-h3 {
            margin-left: 20px;
            margin-top: -12px;
        }
        
        footer hr {
            width: 50%;
            margin-top: 40%;
        }
    }    
  </style>

  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
</head>
<body>
  <div class="header-div">
       <div class="bibo-h3"><h1>Bibliothekskatalog RoRo</h1></div>
       <img class="logo" src="logo.png" alt="Logo der Bibliothek"></div>
  <input type="text" id="search" placeholder="Titel oder Autor suchen..." autocomplete="off" />
  <p id="auswahl-info">- Neuanschaffungen -</p>
  <div id="book-list"></div>

  <div id="lightbox-overlay">
    <div id="lightbox-content"></div>
  </div>

  <footer>
       <hr size="2" noshade>
       <p class="impressum"><a href="impressum.html">Impressum</a></p>
  </footer>

<script>
  const GOOGLE_BOOKS_KEY = "AIzaSyB6-PVmwI_ZGy0fAUiYBtIetw5MJP9Tjy8";
  const supabase = window.supabase.createClient(
    "https://euuptkidjsquvhohvicv.supabase.co",
    "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
  );

  let medien = [];
  let auswahl = [];

  async function ladeMedien() {
    const { data } = supabase.storage.from("medien").getPublicUrl("medien.json");
    const res = await fetch(data.publicUrl);
    medien = await res.json();
    await ladeAuswahl();
    setupSearch();
  }

  async function ladeAuswahl() {
    const { data } = supabase.storage.from("medien").getPublicUrl("auswahl.json");
    const res = await fetch(data.publicUrl);
    auswahl = await res.json();
    renderListeOhneCover(auswahl, document.getElementById("book-list"));
  }

  function setupSearch() {
    const searchInput = document.getElementById("search");
    const container = document.getElementById("book-list");
    const auswahlInfo = document.getElementById("auswahl-info");

    searchInput.addEventListener("keypress", function (e) {
      if (e.key === "Enter") {
        const q = this.value.trim().toLowerCase();
        if (q.length === 0) {
          auswahlInfo.style.display = "block";
          renderListeOhneCover(auswahl, container);
          return;
        }
        auswahlInfo.style.display = "none";
        let gefiltert = medien.filter((b) => {
          const titel = (b.Titel || "").toLowerCase();
          const autor = (b.Autor || "").toLowerCase();
          return titel.includes(q) || autor.includes(q);
        });
        gefiltert = uniqueByNummer(gefiltert);
        renderListeOhneCover(gefiltert, container);
      }
    });
  }

  function uniqueByNummer(arr) {
    const seen = new Set();
    return arr.filter((item) => {
      if (!item.Nummer) return true;
      if (seen.has(item.Nummer)) return false;
      seen.add(item.Nummer);
      return true;
    });
  }

function renderListeOhneCover(liste, container) {
  container.innerHTML = "";
  for (const b of liste) {
    const div = document.createElement("div");
    div.className = "book";
    div.dataset.details = JSON.stringify(b);
    div.innerHTML = `
      <div class="book-details">
        <div class="book-header">
          <div>
            <div class="book-title">${b.Titel || "Ohne Titel"}</div>
            <div class="book-author">${b.Autor || "Unbekannter Autor"}</div>
          </div>
          <div class="book-signature">${b.Signatur || "-"}</div>
        </div>
        <div class="book-meta">MeNummer: ${b.Nummer || "-"} &nbsp;|&nbsp; ISBN: ${(b.ISBN || b.isbn || "-")}</div>
      </div>
    `;
    div.addEventListener("click", () => zeigeLightbox(b));
    container.appendChild(div);
  }
}

async function holeCoverURL(isbn) {
  if (!isbn) return { url: "thumbnail.png", source: "Keine Quelle" };
  const olUrlLarge = `https://covers.openlibrary.org/b/isbn/${isbn}-L.jpg`;

  async function pruefeBild(url) {
    return new Promise((resolve) => {
      const img = new Image();
      img.onload = () => resolve(img.width > 50 && img.height > 50);
      img.onerror = () => resolve(false);
      img.src = url;
    });
  }

  if (await pruefeBild(olUrlLarge)) return { url: olUrlLarge, source: "OpenLibrary" };

  try {
    const googleRes = await fetch(
      `https://www.googleapis.com/books/v1/volumes?q=isbn:${isbn}&key=${GOOGLE_BOOKS_KEY}`
    );
    const googleData = await googleRes.json();
    const imgLinks = googleData.items?.[0]?.volumeInfo?.imageLinks;
    if (imgLinks?.thumbnail) {
      return { url: imgLinks.thumbnail.replace("http:", "https:"), source: "Google Books" };
    }
  } catch {}

  const olUrlMedium = `https://covers.openlibrary.org/b/isbn/${isbn}-M.jpg`;
  if (await pruefeBild(olUrlMedium)) return { url: olUrlMedium, source: "OpenLibrary" };

  return { url: "thumbnail.png", source: "Keine Quelle" };
}

async function zeigeLightbox(buch) {
  const overlay = document.getElementById("lightbox-overlay");
  const content = document.getElementById("lightbox-content");

  let coverHtml = "";
  let quelle = "Keine Quelle";
  const isbnRaw = (buch.ISBN || buch.isbn || "").toString().trim();

  if (isbnRaw) {
    const isbn = isbnRaw.replace(/-/g, "");
    const { url, source } = await holeCoverURL(isbn);
    coverHtml = `<img class="search-cover" src="${url}" alt="Cover von ${buch.Titel || 'Unbekannt'}" />`;

    if (source === "OpenLibrary") {
      quelle = `<a href="https://openlibrary.org/isbn/${isbn}" target="_blank" rel="noopener">OpenLibrary</a>`;
    } else if (source === "Google Books") {
      quelle = `<a href="https://www.google.com/search?tbm=bks&q=isbn:${isbn}" target="_blank" rel="noopener">Google Books</a>`;
    } else {
      quelle = "-";
    }
  } else {
    coverHtml = `<img src="thumbnail.png" alt="Kein Cover verfÃ¼gbar" />`;
  }

  content.innerHTML = `
    ${coverHtml}
    <div class="book-info">
      <div class="label">Titel:</div><div>${buch.Titel || "Ohne Titel"}</div>
      <div class="label">Autor:</div><div>${buch.Autor || "Unbekannter Autor"}</div>
      <div class="label">Signatur:</div><div>${buch.Signatur || "-"}</div>
      <div></div><div></div>
      <div></div><div></div>
      <div class="label">Nummer:</div><div>${buch.Nummer || "-"}</div>
      <div class="label">ISBN:</div><div>${buch.ISBN || buch.isbn || "-"}</div>
      <div></div><div></div><div></div><div></div>
      <div></div><div></div><div></div><div></div>
      <div class="label">Covereintrag:</div><div>${quelle}</div>
    </div>
  `;
  overlay.style.display = "flex";
}

  document.getElementById("lightbox-overlay").addEventListener("click", function(e) {
    if (e.target.id === "lightbox-overlay") {
      this.style.display = "none";
    }
  });

  ladeMedien();
</script>
</body>
</html>
